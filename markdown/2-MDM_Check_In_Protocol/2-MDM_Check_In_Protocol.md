# MDM Check-in Protocol

 [Configuration Profile Reference - MDM Check-in Protocol](https://developer.apple.com/library/content/documentation/Miscellaneous/Reference/MobileDeviceManagementProtocolRef/2-MDM_Check_In_Protocol/MDM_Check_In_Protocol.html)  
  

[Next](https://developer.apple.com/library/content/documentation/Miscellaneous/Reference/MobileDeviceManagementProtocolRef/3-MDM_Protocol/MDM_Protocol.html)[Previous](https://developer.apple.com/library/content/documentation/Miscellaneous/Reference/MobileDeviceManagementProtocolRef/1-Introduction/Introduction.html)
  
The MDM check-in protocol is used during initialization to validate a device’s eligibility for MDM enrollment and to inform the server that a device’s push token has been updated.  
If a check-in server URL is provided in the MDM payload, the check-in protocol is used to communicate with that check-in server. If no check-in server URL is provided, the main MDM server URL is used instead.  
> **Note:** 
MDM configuration profiles can be stored in and read from Apple Open Directory servers.  
  
  

## Structure of a Check-in Request
  

When the MDM payload is installed, the device initiates communication with the check-in server. The device validates the TLS certificate of the server, then uses the identity specified in its MDM payload as the client authentication certificate for the connection.  

After successfully negotiating this secure connection, the device sends an HTTP PUT request in this format:  

```
PUT /your/url HTTP/1.1
Host: www.yourhostname.com
Content-Length: 1234
Content-Type: application/x-apple-aspen-mdm-checkin
 
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
  <dict>
    <key>MessageType</key>
    <string>Authenticate</string>
    <key>Topic</key>
    <string>...</string>
    <key>UDID</key>
    <string>...</string>
  </dict>
</plist>
 
```  

The server must send a `200 (OK)` status code to indicate success or a `401 (Unauthorized)` status code to indicate failure. The body of the reply is ignored.  
  

## Supported Check-in Commands
  

  

### Authenticate Message
  

While the user is installing an MDM payload, the device sends an authenticate message that contains at least three key-value pairs in its property list:  


|Key|Type|Value|
|-|-|-|
|`MessageType`|String|`Authenticate`.|
|`Topic`|String|The topic the device will listen to.|
|`UDID`|String|The device’s UDID.|
  

The device may also send the following key-value pairs if it is running iOS 9 or later and if it has the Device Information access right:  


|Key|Type|Value|
|-|-|-|
|`OSVersion`|String|The device’s OS version.|
|`BuildVersion`|String|The device’s build version.|
|`ProductName`|String|The device’s product name (e.g., `"iPhone3,1"`).|
|`SerialNumber`|String|The device’s serial number.|
|`IMEI`|String|The device’s IMEI (International Mobile Station Equipment Identity).|
|`MEID`|String|The device’s MEID (mobile equipment identifier).|
  

**Server Response**  

On success, the server must respond with a 200 OK status.  

The server should not assume that the device has installed the MDM payload at this time, as other payloads in the profile may still fail to install. When the device has successfully installed the MDM payload, it  sends a token update message.  

  

### TokenUpdate Message
  

A device sends a token update message to the check-in server whenever its device push token, push magic, or unlock token change. These fields are needed by the server to send the device push notifications or passcode resets.  

The `TokenUpdate` message contains these key-value pairs in its property list:  


|Key|Type|Value|
|-|-|-|
|`MessageType`|String|`TokenUpdate`.|
|`Topic`|String|The topic the device will listen to.|
|`UDID`|String|The device’s UDID.|
|`Token`|Data|The push token for the device. The server should use this updated token when sending push notifications to the device.</br>**Warning:** The size of the device push token may vary, and MDM servers cannot assume that all push tokens will be of equal size. However, while the size of the largest push token may change in future releases, MDM servers may assume that it is no larger than 100 bytes currently.|
|`PushMagic`|String|The magic string that must be included in the push notification message. This value is generated by the device (see below).|
|`UnlockToken`|Data|Optional. A data blob that can be used to unlock the device. If provided, the server should remember this data blob and send it with the [ClearPasscode Commands Clear the Passcode for a Device](https://developer.apple.com/library/content/documentation/Miscellaneous/Reference/MobileDeviceManagementProtocolRef/3-MDM_Protocol/MDM_Protocol.html#//apple_ref/doc/uid/TP40017387-CH3-SW1) command. This feature is not available in macOS.</br>The data blob may be up to 8 kB in size after Base64 decoding.|
|`AwaitingConfiguration`|Boolean|Optional. If set to `true`, the device is awaiting a `DeviceConfigured` MDM command before proceeding through Setup Assistant. **Availability:** Available in iOS 9 and later and can only be sent by DEP (see [Device Enrollment Program](https://developer.apple.com/library/content/documentation/Miscellaneous/Reference/MobileDeviceManagementProtocolRef/4-Profile_Management/ProfileManagement.html#//apple_ref/doc/uid/TP40017387-CH7-SW1)).|
  

The device sends an initial token update message to the server when it has installed the MDM payload. The server should send push messages to the device only after receiving the first token update message. If the device reports that it is `AwaitingConfiguration`, the MDM server is expected to send a `DeviceConfigured` MDM command before the device can allow the user to proceed in Setup Assistant. This gives the MDM server the opportunity to do some setup via MDM commands.  

In addition to sending the initial `TokenUpdate` message, the iOS device may now send additional `TokenUpdate` messages to the check-in server at any time while it has a valid MDM enrollment.  

The use of `PushMagic` constrains the device to a unique MDM relationship. When a user removes the MDM profile, the device should no longer listen to the former relationship, even if the user reestablishes a management relationship with the same server topic. Note that only the push topic is the same in this case; the server’s address could have changed. This also helps when a user restores a device from backup that contains an older relationship. The use of `PushMagic` also ensures that the server that receives the CheckIn message is owned by the same enterprise as the computer sending push notifications. This is important because there is no way of knowing if the push topic belongs to the owner of the checkin server. It is conceivable that Apple could revoke a push token for one party, only to have that party re-enroll people piggybacking on some other topic that’s actively pushing. The fact that all MDM push topics reside in the namespace `com.apple.mgmt.*` helps prevent this.  

> **Warning:** 
The `PushMagic` or `UnlockToken` fields of subsequent `TokenUpdate` messages may be identical to those in previous messages or may be different (and may differ in size from previous values). If different, the server should update its record for the device to the new value provided by the message. Failure to do so results in the server being unable to send push notifications or perform passcode resets.  
  

While the `UnlockToken` message can be sent multiple times by the device, it is possible it may only be sent once if `PushMagic` or `UnlockToken` values change. Implementations should not rely on repeated messages to update lost server-side data or to recover from a failure to process a previous `TokenUpdate` message.  

> **Note:** The topic string for the MDM check-in protocol must start with `com.apple.mgmt.*` where `*` is a unique suffix.  
  

  

### CheckOut
  

In iOS 5.0 and later, and in macOS v10.9, if the `CheckOutWhenRemoved` key in the MDM payload is set to `true`, the device attempts to send a `CheckOut` message when the MDM profile is removed.  

In macOS v10.8, the device attempts to send a `CheckOut` message when the MDM profile is removed regardless of the value of this key (or its absence).  

If network conditions do not allow the message to be delivered successfully, the device makes no further attempts to send the message.  

The server’s response to this message is ignored.  

The `CheckOut` message contains the following keys:  


|Key|Type|Content|
|-|-|-|
|`MessageType`|String|`CheckOut`.|
|`Topic`|String|The topic the device will listen to.|
|`UDID`|String|The device’s UDID.|
  

[Next](https://developer.apple.com/library/content/documentation/Miscellaneous/Reference/MobileDeviceManagementProtocolRef/3-MDM_Protocol/MDM_Protocol.html)[Previous](https://developer.apple.com/library/content/documentation/Miscellaneous/Reference/MobileDeviceManagementProtocolRef/1-Introduction/Introduction.html)

  



